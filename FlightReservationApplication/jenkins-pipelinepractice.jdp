pipeline {
  agent any

  tools {
    jdk 'jdk17'
    maven 'maven'
    nodejs 'node20'
  }

  environment {
    // --- Database Configuration ---
    DB_HOST = "database.cp2oyu6myvq8.ap-south-1.rds.amazonaws.com"
    DB_NAME = "flightdb"
    DB_USER = "admin"
    DB_PASS = "admin1234"

    // --- Backend & Frontend Info ---
    BACKEND_IP = "13.233.142.157"    // Jenkins server public IP (backend)
    BACKEND_PORT = "8080"
    FRONTEND_IP = "35.154.94.69"     // Frontend EC2 public IP (Nginx server)
  }

  stages {

    /* --------------------------
       1Ô∏è‚É£  CLONE SOURCE CODE
    -------------------------- */
    stage('Checkout Source Code') {
      steps {
        echo "üì¶ Cloning source code from GitHub..."
        git branch: 'main', url: 'https://github.com/Jitendra1137/Flight-reservation.git'
      }
    }

    /* --------------------------
       2Ô∏è‚É£  BUILD BACKEND (Maven)
    -------------------------- */
    stage('Build Backend') {
      steps {
        dir('FlightReservationApplication') {
          sh '''
            echo "‚öôÔ∏è Building Spring Boot backend..."
            mvn clean package -DskipTests
          '''
        }
      }
    }

    /* --------------------------
       3Ô∏è‚É£  RUN BACKEND ON JENKINS SERVER
    -------------------------- */
    stage('Run Backend on Jenkins Server') {
      steps {
        sh '''
          echo "üöÄ Starting backend on Jenkins server..."
          pkill -f 'java -jar' || true
          nohup java -jar FlightReservationApplication/target/*.jar > backend.log 2>&1 &
          sleep 5
          echo "‚úÖ Backend started on port 8080"
        '''
      }
    }

    /* --------------------------
       4Ô∏è‚É£  BUILD FRONTEND (React)
    -------------------------- */
    stage('Build Frontend') {
      steps {
        dir('frontend') {
          sh '''
            echo "‚öôÔ∏è Building React frontend..."
            echo "VITE_API_URL=http://${BACKEND_IP}:${BACKEND_PORT}" > .env
            npm install
            npm run build
          '''
        }
      }
    }

    /* --------------------------
       5Ô∏è‚É£  DEPLOY FRONTEND TO NGINX SERVER
    -------------------------- */
    stage('Deploy Frontend to Nginx Server') {
      steps {
        sshagent(['ec2-ssh-key']) {
          sh '''
            echo "üöÄ Deploying frontend to Nginx server..."
            scp -r -o StrictHostKeyChecking=no frontend/dist/* ubuntu@${FRONTEND_IP}:/tmp/dist/
            ssh -o StrictHostKeyChecking=no ubuntu@${FRONTEND_IP} "
              sudo rm -rf /var/www/html/*
              sudo cp -r /tmp/dist/* /var/www/html/
              sudo systemctl restart nginx
            "
          '''
        }
      }
    }
  }

  /* --------------------------
     ‚úÖ POST STAGES
  -------------------------- */
  post {
    success {
      echo "‚úÖ Deployment Successful!"
      echo "üåê Backend:  http://${BACKEND_IP}:${BACKEND_PORT}"
      echo "üíª Frontend: http://${FRONTEND_IP}"
    }
    failure {
      echo "‚ùå Deployment Failed! Check Jenkins console output for details."
    }
  }
}
