pipeline {
  agent any

  environment {
    // --- Database Configuration ---
    DB_HOST = "database.cp2oyu6myvq8.ap-south-1.rds.amazonaws.com"
    DB_NAME = "flightdb"
    DB_USER = "admin"
    DB_PASS = "admin1234"

    // --- App Info ---
    BACKEND_PORT = "8080"
    FRONTEND_PORT = "80"
  }

  stages {

    /* --------------------------
       1ï¸âƒ£ CHECKOUT CODE
    -------------------------- */
    stage('Checkout Code') {
      steps {
        echo "ğŸ“¦ Cloning repository..."
        git branch: 'main', url: 'https://github.com/Jitendra1137/Flight-reservation.git'
      }
    }

    /* --------------------------
       2ï¸âƒ£ BUILD BACKEND
    -------------------------- */
    stage('Build Backend') {
      steps {
        dir('FlightReservationApplication') {
          sh '''
            echo "âš™ï¸ Building Spring Boot backend..."
            mvn clean package -DskipTests
          '''
        }
      }
    }

    /* --------------------------
       3ï¸âƒ£ RUN BACKEND
    -------------------------- */
    stage('Run Backend') {
      steps {
        sh '''
          echo "ğŸš€ Starting backend on port 8080..."
          pkill -f 'java -jar' || true
          nohup java -jar FlightReservationApplication/target/*.jar > backend.log 2>&1 &
          sleep 5
          echo "âœ… Backend started successfully"
        '''
      }
    }

    /* --------------------------
       4ï¸âƒ£ BUILD FRONTEND
    -------------------------- */
    stage('Build Frontend') {
      steps {
        dir('frontend') {
          sh '''
            echo "âš™ï¸ Building React frontend..."
            echo "VITE_API_URL=http://localhost:${BACKEND_PORT}" > .env
            npm install
            npm run build
          '''
        }
      }
    }

    /* --------------------------
       5ï¸âƒ£ DEPLOY FRONTEND (Nginx)
    -------------------------- */
    stage('Deploy Frontend') {
      steps {
        sh '''
          echo "ğŸš€ Deploying frontend to Nginx..."
          sudo rm -rf /var/www/html/*
          sudo cp -r frontend/dist/* /var/www/html/
          sudo systemctl restart nginx
          echo "âœ… Frontend deployed successfully!"
        '''
      }
    }
  }

  post {
    success {
      echo "âœ… Deployment Completed Successfully!"
      echo "ğŸŒ Backend:  http://<jenkins-public-ip>:8080"
      echo "ğŸ’» Frontend: http://<jenkins-public-ip>"
    }
    failure {
      echo "âŒ Deployment Failed! Check Jenkins console logs."
    }
  }
}
