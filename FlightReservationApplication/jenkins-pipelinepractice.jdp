pipeline {
  agent any

  environment {
    // --- Database Configuration ---
    DB_HOST = "database.cp2oyu6myvq8.ap-south-1.rds.amazonaws.com"
    DB_NAME = "flightdb"
    DB_USER = "admin"
    DB_PASS = "admin1234"

    // --- Application Info ---
    BACKEND_PORT = "8080"
  }

  stages {

    /* --------------------------
       1Ô∏è‚É£  CHECKOUT CODE
    -------------------------- */
    stage('Checkout Code') {
      steps {
        echo "üì¶ Cloning repository..."
        git branch: 'main', url: 'https://github.com/Jitendra1137/Flight-reservation.git'
      }
    }

    /* --------------------------
       2Ô∏è‚É£  BUILD BACKEND
    -------------------------- */
    stage('Build Backend') {
      steps {
        dir('FlightReservationApplication') {
          sh '''
            echo "‚öôÔ∏è Building Spring Boot backend..."
            mvn clean package -DskipTests
          '''
        }
      }
    }

    /* --------------------------
       3Ô∏è‚É£  RUN BACKEND
    -------------------------- */
    stage('Run Backend') {
      steps {
        sh '''
          echo "üöÄ Starting backend on port ${BACKEND_PORT}..."
          pkill -f 'java -jar' || true
          nohup java -jar FlightReservationApplication/target/*.jar > backend.log 2>&1 &
          sleep 5
          echo "‚úÖ Backend started successfully"
        '''
      }
    }

    /* --------------------------
       4Ô∏è‚É£  BUILD FRONTEND
    -------------------------- */
    stage('Build Frontend') {
      steps {
        dir('frontend') {
          sh '''
            echo "‚öôÔ∏è Building React frontend..."
            echo "VITE_API_URL=http://localhost:${BACKEND_PORT}" > .env
            npm install
            npm run build
          '''
        }
      }
    }

    /* --------------------------
       5Ô∏è‚É£  DEPLOY FRONTEND (No sudo)
    -------------------------- */
    stage('Deploy Frontend') {
      steps {
        sh '''
          echo "üöÄ Deploying frontend to Nginx..."
          rm -rf /var/www/html/*
          cp -r frontend/dist/* /var/www/html/
          systemctl restart nginx || true
          echo "‚úÖ Frontend deployed successfully!"
        '''
      }
    }

    /* --------------------------
       6Ô∏è‚É£  HEALTH CHECK
    -------------------------- */
    stage('Health Check') {
      steps {
        sh '''
          echo "üîç Checking services..."
          echo "Backend:"; curl -I http://localhost:${BACKEND_PORT} || true
          echo "Frontend:"; curl -I http://localhost || true
        '''
      }
    }
  }

  post {
    success {
      echo "‚úÖ Deployment Completed Successfully!"
      echo "üåê Backend:  http://<jenkins-public-ip>:${BACKEND_PORT}"
      echo "üíª Frontend: http://<jenkins-public-ip>"
    }
    failure {
      echo "‚ùå Deployment Failed! Check Jenkins console logs."
    }
  }
}
