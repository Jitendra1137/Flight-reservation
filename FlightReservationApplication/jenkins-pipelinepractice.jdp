pipeline {
  agent any

  environment {
    // --- Database Configuration ---
    DB_HOST = "database.cp2oyu6myvq8.ap-south-1.rds.amazonaws.com"
    DB_NAME = "flightdb"
    DB_USER = "admin"
    DB_PASS = "admin1234"

    // --- Server Info ---
    BACKEND_IP = "13.233.142.157"   // Jenkins/Backend Server IP
    BACKEND_PORT = "8080"
    FRONTEND_IP = "35.154.94.69"    // Frontend (Nginx + NodeJS) Server IP
  }

  stages {

    /* --------------------------
       1ï¸âƒ£  CLONE SOURCE CODE
    -------------------------- */
    stage('Checkout Source Code') {
      steps {
        echo "ğŸ“¦ Cloning source code from GitHub..."
        git branch: 'main', url: 'https://github.com/Jitendra1137/Flight-reservation.git'
      }
    }

    /* --------------------------
       2ï¸âƒ£  BUILD BACKEND (Spring Boot)
    -------------------------- */
    stage('Build Backend') {
      steps {
        dir('FlightReservationApplication') {
          sh '''
            echo "âš™ï¸ Building Spring Boot backend..."
            mvn clean package -DskipTests
          '''
        }
      }
    }

    /* --------------------------
       3ï¸âƒ£  RUN BACKEND ON JENKINS SERVER
    -------------------------- */
    stage('Run Backend on Jenkins Server') {
      steps {
        sh '''
          echo "ğŸš€ Starting backend on Jenkins server..."
          pkill -f 'java -jar' || true
          nohup java -jar FlightReservationApplication/target/*.jar > backend.log 2>&1 &
          sleep 5
          echo "âœ… Backend running on port 8080"
        '''
      }
    }

    /* --------------------------
       4ï¸âƒ£  BUILD FRONTEND REMOTELY (on Frontend Server)
    -------------------------- */
    stage('Build Frontend on Remote Server') {
      steps {
        sshagent(['ec2-ssh-key']) {
          sh '''
          echo "âš™ï¸ Building React frontend on remote server..."

          ssh -o StrictHostKeyChecking=no ubuntu@${FRONTEND_IP} "
            sudo rm -rf /home/ubuntu/frontend_build &&
            mkdir -p /home/ubuntu/frontend_build &&
            cd /home/ubuntu/frontend_build &&
            git clone https://github.com/Jitendra1137/Flight-reservation.git . &&
            cd frontend &&
            echo 'VITE_API_URL=http://${BACKEND_IP}:${BACKEND_PORT}' > .env &&
            npm install &&
            npm run build &&
            sudo rm -rf /var/www/html/* &&
            sudo cp -r dist/* /var/www/html/ &&
            sudo systemctl restart nginx
          "
          '''
        }
      }
    }
  }

  /* --------------------------
     âœ… POST ACTIONS
  -------------------------- */
  post {
    success {
      echo "âœ… Deployment Successful!"
      echo "ğŸŒ Backend:  http://${BACKEND_IP}:${BACKEND_PORT}"
      echo "ğŸ’» Frontend: http://${FRONTEND_IP}"
    }
    failure {
      echo "âŒ Deployment Failed! Check Jenkins logs."
    }
  }
}
